---
# GitHub Actions Workflow responsible for cleaning up the Claude Starter Kit Template repository from
# the template-specific files and configurations. This workflow is supposed to be triggered manually by the user
# after a new template-based repository has been created.

name: Template Cleanup
on:
  workflow_dispatch:
    inputs:
      CC_MODEL:
        description: |
          Default model to use with claude-code.
          See https://code.claude.com/docs/en/model-config#model-aliases for model aliases.
        required: true
        default: default
        type: choice
        options:
          - default
          - sonnet
          - sonnet[1m]
          - opus
          - opusplan
          - haiku
          # NOTE: does not currently support 1m context.
          # Model name from: https://platform.claude.com/docs/en/about-claude/models/overview#model-names
          - claude-opus-4-5
      LANGUAGE:
        description: |
          Primary programming language(s) of this project.
          Used for Serena semantic analysis (e.g., "python", "typescript", "java").
          See Serena docs for supported languages.
        required: false
        default: ""
        type: string
      SERENA_INITIAL_PROMPT:
        description: Initial prompt/context for Serena semantic analysis.
        required: false
        default: ""
        type: string
      TM_CUSTOM_SYSTEM_PROMPT:
        description: Custom system prompt to override Claude Code default behavior in Task Master.
        required: false
        default: ""
        type: string
      TM_APPEND_SYSTEM_PROMPT:
        description: Additional content to append to Claude Code system prompt in Task Master.
        required: false
        default: ""
        type: string
      TM_PERMISSION_MODE:
        description: Task Master permission mode for file system operations.
        required: false
        default: default
        type: choice
        options:
          - default
          - acceptEdits
          - plan
          - bypassPermissions

jobs:
  # Run cleaning process only if workflow is triggered by the non-"claude-starter-kit" repository.
  template-cleanup:
    name: Template Cleanup
    runs-on: ubuntu-latest
    if: github.event.repository.name != 'claude-starter-kit'
    permissions:
      contents: write
    steps:
      # Check out current repository
      - name: Fetch Sources
        uses: actions/checkout@v4

      # Cleanup project
      - name: Cleanup
        run: |
          export LC_CTYPE=C
          export LANG=C

          # Prepare repository-specific variables
          NAME="${GITHUB_REPOSITORY##*/}"

          # Get workflow input variables
          LANGUAGE="${{ github.event.inputs.LANGUAGE }}"
          CC_MODEL="${{ github.event.inputs.CC_MODEL }}"
          SERENA_INITIAL_PROMPT="${{ github.event.inputs.SERENA_INITIAL_PROMPT }}"
          TM_CUSTOM_SYSTEM_PROMPT="${{ github.event.inputs.TM_CUSTOM_SYSTEM_PROMPT }}"
          TM_APPEND_SYSTEM_PROMPT="${{ github.event.inputs.TM_APPEND_SYSTEM_PROMPT }}"
          TM_PERMISSION_MODE="${{ github.event.inputs.TM_PERMISSION_MODE }}"

          # Substitute default values with user-provided values
          # Note: Templates now use actual working values instead of placeholders

          # Claude Code Settings
          cc_settings_file=".github/templates/claude/settings.json"
          # Claude Code model - always substitute (user selects from dropdown)
          sed -i "s/\"model\": \".*\"/\"model\": \"$CC_MODEL\"/g" "$cc_settings_file"

          # Serena MCP Settings
          serena_settings_file=".github/templates/serena/project.yml"
          # Project name - always substitute with repo name
          sed -i "s/project_name: \".*\"/project_name: \"$NAME\"/g" "$serena_settings_file"
          # Language - only substitute if provided
          if [ -n "$LANGUAGE" ]; then
            sed -i "s/language: \".*\"/language: \"$LANGUAGE\"/g" "$serena_settings_file"
          fi
          # Serena initial prompt - only substitute if provided
          if [ -n "$SERENA_INITIAL_PROMPT" ]; then
            sed -i "s/initial_prompt: \"\"/initial_prompt: \"$SERENA_INITIAL_PROMPT\"/g" "$serena_settings_file"
          fi

          # TaskMaster MCP Settings
          tm_settings_file=".github/templates/taskmaster/config.json"
          # Project name - always substitute with repo name
          sed -i "s/\"projectName\": \".*\"/\"projectName\": \"$NAME\"/g" "$tm_settings_file"
          # Task Master prompts - only substitute if provided
          if [ -n "$TM_CUSTOM_SYSTEM_PROMPT" ]; then
            sed -i "s/\"customSystemPrompt\": \"\"/\"customSystemPrompt\": \"$TM_CUSTOM_SYSTEM_PROMPT\"/g" "$tm_settings_file"
          fi
          if [ -n "$TM_APPEND_SYSTEM_PROMPT" ]; then
            sed -i "s/\"appendSystemPrompt\": \"\"/\"appendSystemPrompt\": \"$TM_APPEND_SYSTEM_PROMPT\"/g" "$tm_settings_file"
          fi
          if [ -n "$TM_PERMISSION_MODE" ]; then
            sed -i "s/\"permissionMode\": \"\"/\"permissionMode\": \"$TM_PERMISSION_MODE\"/g" "$tm_settings_file"
          fi

          rm -rf .claude .serena .taskmaster

          # Deploy templates to destination locations
          cp -r .github/templates/claude ./.claude
          cp -r .github/templates/serena ./.serena
          cp -r .github/templates/taskmaster ./.taskmaster
          cp .github/templates/bootstrap.sh .

          # Complete cleanup - remove everything except preserved files/directories
          # Preserve: .git/, .gitignore, .serena/, .taskmaster/, .claude/
          find . -mindepth 1 -maxdepth 1 \
            ! -name '.git' \
            ! -name '.gitignore' \
            ! -name '.claude' \
            ! -name '.serena' \
            ! -name '.taskmaster' \
            ! -name 'bootstrap.sh' \
            -exec rm -rf {} +

          # Generate minimal README
          echo "# $NAME" > README.md

      # Commit modified files
      - name: Commit files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Template cleanup"

      # Push changes
      - name: Push changes
        run: |-
          BRANCH=$(git branch --show-current)
          git push origin $BRANCH
